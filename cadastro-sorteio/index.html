<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro no Sorteio</title>
  <link rel="stylesheet" href="style.css">
  <link rel="shortcut icon" href="logo dom manoel.png" type="image/x-icon">
</head>
<body>
  <div id="bgVideo">
    <video  autoplay muted loop playsinline src="background.mp4"></video>
  </div>

  <div class="container" id="form-wrapper">
    <!-- Etapa 1: C칩digo -->
    <div id="etapa1" class="etapa ativa">
      <img src="logo dom manoel.png" id="logo-dommanoel" alt="">
      <h1>Confirme seu c칩digo</h1>
      <form id="formCodigo">
        <input type="text" id="codigo" placeholder="Digite seu c칩digo" required>
        <button type="submit">Avan칞ar</button>
      </form>
      <p id="mensagemCodigo" class="mensagem"></p>
    </div>

    <!-- Etapa 2: Nome -->
    <div id="etapa2" class="etapa">
      <img src="logo dom manoel.png" id="logo-dommanoel" alt="">      
      <h1>Digite seu nome completo</h1>
      <form id="formNome">
        <input type="text" id="nome" placeholder="Nome completo" required>
        <button type="submit">Avan칞ar</button>
      </form>
    </div>

    <!-- Etapa 3: Telefone -->
    <div id="etapa3" class="etapa">
      <img src="logo dom manoel.png" id="logo-dommanoel" alt="">
      <h1>Digite seu telefone</h1>
      <form id="formTelefone">
        <input type="tel" id="telefone" placeholder="(XX) X XXXX-XXXX" required>
        <button type="submit">Concluir Cadastro</button>
      </form>
    </div>

    <!-- Etapa 4: Confirma칞칚o -->
    <div>
      <div id="etapa4" class="etapa">
        <h1>游꿀 Cadastro conclu칤do!</h1>
        <p style="font-size: 16px; color: #888888; margin-bottom: 20px;">
          Toque no bot칚o abaixo para garantir seu <strong>cupom</strong>, seguindo-nos no instagram!
        </p>
        <a id="btnInstagram"
           href="instagram://media?id=DL58vWPOAPh"
           style="display:inline-block; background:#E1306C; color:#fff; padding:15px 20px; border-radius:10px; font-size:18px; font-weight:bold; text-decoration:none; transition: all 0.3s;">
           游녤 Abrir no Instagram
        </a>
        <p style="font-size: 13px; color: #888; margin-top: 10px;">(Promo칞칚o v치lida por tempo limitado)</p>
      </div>
    </div>

  </div>
  <footer>

  <p>
    춸 2025 <a href="https://www.teamcriativa.com/">Ag칡ncia Criativa</a> - Solu칞칫es para o seu neg칩cio.
  </p>
</footer>



<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  console.log('Script iniciado');
  
  const supabaseUrl = 'https://zbvirsjyvybhpusdnjxq.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpidmlyc2p5dnliaHB1c2RuanhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUzNDI3OTcsImV4cCI6MjA2MDkxODc5N30.wTP6w7pyZNIWkhuvv2OMLx6kfnh5_-iice8q_141HUE';
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM completamente carregado');
    
    const etapas = document.querySelectorAll('.etapa');
    const formCodigo = document.getElementById('formCodigo');
    const formNome = document.getElementById('formNome');
    const formTelefone = document.getElementById('formTelefone');
    const codigoInput = document.getElementById('codigo');
    const nomeInput = document.getElementById('nome');
    const telefoneInput = document.getElementById('telefone');
    const mensagemCodigo = document.getElementById('mensagemCodigo');
    let codigoValido = '';

    console.log('Elementos DOM carregados:', {
      etapas, formCodigo, formNome, formTelefone, 
      codigoInput, nomeInput, telefoneInput, mensagemCodigo
    });

    // M치scara telefone
    telefoneInput.addEventListener('input', function (e) {
      console.log('Input de telefone alterado:', e.target.value);
      let value = e.target.value.replace(/\D/g, '');
      let formattedValue = '';
      if (value.length > 0) formattedValue = '(' + value.substring(0, 2);
      if (value.length > 2) formattedValue += ') ' + value.substring(2, 3);
      if (value.length > 3) formattedValue += ' ' + value.substring(3, 7);
      if (value.length > 7) formattedValue += '-' + value.substring(7, 11);
      e.target.value = formattedValue;
      console.log('Telefone formatado:', e.target.value);
    });

    // For칞ar uppercase nos inputs
    codigoInput.addEventListener('input', function () {
      console.log('Input de c칩digo alterado (antes):', this.value);
      this.value = this.value.toUpperCase();
      console.log('Input de c칩digo alterado (depois):', this.value);
    });
    
    nomeInput.addEventListener('input', function () {
      console.log('Input de nome alterado (antes):', this.value);
      this.value = this.value.toUpperCase();
      console.log('Input de nome alterado (depois):', this.value);
    });

    // Fun칞칚o para mostrar a etapa correta
    function mostrarEtapa(numero) {
      console.log(`Mostrando etapa ${numero}`);
      etapas.forEach(etapa => {
        console.log(`Etapa ${etapa.id} - classe atual:`, etapa.classList.toString());
        etapa.classList.remove('ativa');
      });
      const etapaAtiva = document.getElementById(`etapa${numero}`);
      etapaAtiva.classList.add('ativa');
      console.log(`Etapa ${etapaAtiva.id} - nova classe:`, etapaAtiva.classList.toString());
    }

    // Valida c칩digo e avan칞a etapas
    async function validarCodigo(codigo, mostrarErro = true) {
      console.log(`Validando c칩digo: ${codigo}, mostrarErro: ${mostrarErro}`);
      
      try {
        console.log('Iniciando consulta ao Supabase...');
        const { data, error } = await supabaseClient
          .from('sorteio')
          .select('nome, telefone')
          .eq('codigo', codigo)
          .maybeSingle();

        console.log('Resposta do Supabase:', { data, error });

        if (error) {
          console.error('Erro do Supabase:', error);
          throw error;
        }

        if (data) {
          if (data.nome) {
            console.log('C칩digo j치 utilizado');
            if(mostrarErro) {
              mensagemCodigo.textContent = 'C칩digo EXPIRADO, entre em contato com a loja e saiba mais.';
              const formWrapper = document.getElementById('form-wrapper');

              // Adiciona classe de tremor
              formWrapper.classList.add('shake');

              // Vibra no celular (se suportado)
              if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]); // vibra 200ms, pausa 100ms, vibra 200ms
              }

              // Remove a classe ap칩s a anima칞칚o terminar (300ms)
              setTimeout(() => {
                formWrapper.classList.remove('shake');
              }, 300);

                console.log('Mensagem de erro exibida');
              }
            return false;
          } else {
            console.log('C칩digo v치lido e n칚o utilizado');
            codigoValido = codigo;
            mostrarEtapa(2);
            mensagemCodigo.textContent = '';
            return true;
          }
        } else {
          console.log('C칩digo n칚o encontrado');
          if(mostrarErro) {
            mensagemCodigo.textContent = 'C칩digo divergente, corrija-o ou solicite um novo.';
            const formWrapper = document.getElementById('form-wrapper');

            // Adiciona classe de tremor
            formWrapper.classList.add('shake');

            // Vibra no celular (se suportado)
            if (navigator.vibrate) {
              navigator.vibrate([200, 100, 200]); // vibra 200ms, pausa 100ms, vibra 200ms
            }

            // Remove a classe ap칩s a anima칞칚o terminar (300ms)
            setTimeout(() => {
              formWrapper.classList.remove('shake');
            }, 300);

            console.log('Mensagem de erro exibida');
          }
          return false;
        }
      } catch (error) {
        console.error('Erro ao validar c칩digo:', error);
        if(mostrarErro) {
          mensagemCodigo.textContent = 'Erro ao verificar c칩digo. Tente novamente.';
          console.log('Mensagem de erro exibida');
        }
        return false;
      }
    }

    // Tratamento do submit do c칩digo
    formCodigo.addEventListener('submit', async function (e) {
      e.preventDefault();
      const codigo = codigoInput.value.trim();
      console.log('Formul치rio de c칩digo submetido:', codigo);
      
      if(codigo === '') {
        console.log('C칩digo vazio');
        mensagemCodigo.textContent = 'Digite seu c칩digo.';
        return;
      }
      
      await validarCodigo(codigo);
    });

    // Avan칞a para etapa 3 (nome)
    formNome.addEventListener('submit', function (e) {
      e.preventDefault();
      const nome = nomeInput.value.trim();
      console.log('Formul치rio de nome submetido:', nome);
      
      if (nome === '') {
        console.log('Nome vazio');
        alert('Por favor, digite seu nome completo.');
        return;
      }
      
      mostrarEtapa(3);
    });

    // Envia telefone e conclui cadastro
    formTelefone.addEventListener('submit', async function (e) {
      e.preventDefault();
      const telefone = telefoneInput.value.replace(/\D/g, '');
      console.log('Formul치rio de telefone submetido:', telefone);
      
      if (telefone.length !== 11) {
        console.log('Telefone inv치lido');
        alert('Por favor, digite um telefone v치lido com 11 d칤gitos.');
        return;
      }
      
      try {
        console.log('Enviando dados para o Supabase...');
        const cadastramento = new Date().toISOString();
        const { error } = await supabaseClient
          .from('sorteio')
          .update({
            nome: nomeInput.value.trim(),
            telefone: telefone,
            cadastramento: cadastramento
          })
          .eq('codigo', codigoValido);

        console.log('Resposta do Supabase:', { error });

        if (error) throw error;

        console.log('Cadastro conclu칤do com sucesso');
        mostrarEtapa(4);
      } catch (error) {
        console.error('Erro ao enviar dados:', error);
        alert('Erro ao enviar dados. Tente novamente.');
      }
    });

    // Bot칚o Instagram
    document.getElementById('btnInstagram').addEventListener('click', function () {
      console.log('Bot칚o Instagram clicado');
      setTimeout(() => {
        window.location.href = 'https://www.instagram.com/p/DL58vWPOAPh/?igsh=YWtkY20xOTFxZHVh';
      }, 1500);
    });

    // In칤cio - preenche c칩digo da URL e tenta validar e pular etapa 1 se poss칤vel
    (async function init() {
      console.log('Iniciando fun칞칚o init()');
      
      const params = new URLSearchParams(window.location.search);
      const codigoUrl = params.get('codigo');
      console.log('C칩digo da URL:', codigoUrl);
      
      if (codigoUrl) {
        console.log('C칩digo encontrado na URL');
        const codigoUpper = codigoUrl.toUpperCase();
        console.log('C칩digo em mai칰sculas:', codigoUpper);
        
        codigoInput.value = codigoUpper;
        console.log('Valor do input de c칩digo definido:', codigoInput.value);
        
        // Dispara eventos para garantir formata칞칚o
        const inputEvent = new Event('input', { bubbles: true });
        codigoInput.dispatchEvent(inputEvent);
        console.log('Evento de input disparado');
        
        // Aguarda um pouco para garantir que o valor foi setado
        await new Promise(resolve => setTimeout(resolve, 100));
        console.log('Delay de 100ms conclu칤do');
        
        // Valida o c칩digo sem mostrar mensagens de erro
        console.log('Validando c칩digo automaticamente...');
        const valido = await validarCodigo(codigoUpper, false);
        console.log('Resultado da valida칞칚o:', valido);
        
        if (!valido) {
          console.log('C칩digo inv치lido, mostrando etapa 1');
          mostrarEtapa(1);
        }
      } else {
        console.log('Nenhum c칩digo na URL, mostrando etapa 1');
        mostrarEtapa(1);
      }
    })();
  });
</script>
<script src="https://www.teamcriativa.com/SCRIPTS/preloader.js"></script>
<script src="https://www.teamcriativa.com/SCRIPTS/logo.js"></script>
<script src="https://www.teamcriativa.com/SCRIPTS/fonts-and-resets.js"></script>

</body>
</html>
